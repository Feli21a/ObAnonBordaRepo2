<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/img/LogoPreguntiaSF.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@700&family=Special+Elite&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/css/styleRuleta.css">
    <script src="/js/soundEffects.js" type="module"></script>

    <title>Ruleta de Preguntas con Respuestas</title>
</head>

<body>
    <!-- Información del jugador -->
    <div id="player-info" class="small-player-info">
        <h3>Jugador: <span id="playerName">Cargando...</span></h3>
        <p>Correctas: <span id="correctAnswers">0</span></p>
    </div>

    <!-- Contenedor principal -->
    <div class="container">
        <div id="chart">
            <div id="marker"></div>
            <button class="spin-button" id="spinButton" onclick="spin()">Girar</button>
        </div>
    </div>

    <!-- Modal de Pregunta y Respuestas -->
    <div id="questionModal" class="modal">
        <div class="modal-content">
            <h2 id="modal-question-text">Pregunta</h2>
            <div id="modal-options">
                <button class="answer-button" onclick="selectAnswer(this)">Opción 1</button>
                <button class="answer-button" onclick="selectAnswer(this)">Opción 2</button>
                <button class="answer-button" onclick="selectAnswer(this)">Opción 3</button>
                <button class="answer-button" onclick="selectAnswer(this)">Opción 4</button>
            </div>
            <button class="close-modal-button" onclick="closeModal()">Cerrar</button>
        </div>
    </div>

    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Cargar el nombre del usuario
            fetch("/api/users/perfil")
                .then(response => response.ok ? response.text() : Promise.reject("No se pudo cargar el perfil"))
                .then(username => {
                    document.getElementById("playerName").textContent = username;
                })
                .catch(error => console.error("Error al cargar el nombre de usuario:", error));
        });

        // Configuración para la ruleta
        var w = 500, h = 500, r = Math.min(w, h) / 2, rotation = 0, oldrotation = 0, picked = 100000, oldpick = [],
            color = d3.scale.category20();

        var data = [
            { "label": "Geografía", "image": "img/MundiGeografo.png" },
            { "label": "Entretenimiento", "image": "img/MundiEntretenimiento.png" },
            { "label": "Historia", "image": "img/MundiHistoriador.png" },
            { "label": "Ciencia", "image": "img/MundiCientifico.png" },
            { "label": "Tecnología", "image": "img/MundiTecnologico.png" },
            { "label": "Deportes", "image": "img/MundiDeportista.png" }
        ];

        // Configuración del gráfico D3
        var svg = d3.select('#chart').append("svg").data([data]).attr("width", w).attr("height", h);
        var container = svg.append("g").attr("class", "chartholder").attr("transform", "translate(" + (w / 2) + "," + (h / 2) + ")");
        var vis = container.append("g");

        var pie = d3.layout.pie().sort(null).value(function () { return 1; });
        var arc = d3.svg.arc().outerRadius(r);

        var arcs = vis.selectAll("g.slice").data(pie).enter().append("g").attr("class", "slice");

        arcs.append("path")
            .attr("fill", function (d, i) { return d3.scale.category20()(i); })
            .attr("d", arc);

        // Añadir imágenes de categorías en la ruleta
        arcs.append("image")
            .attr("xlink:href", function (d, i) { return data[i].image; })
            .attr("width", 70)
            .attr("height", 70)
            .attr("transform", function (d) {
                const angle = (d.startAngle + d.endAngle) / 2 * 180 / Math.PI - 90;
                return `rotate(${angle})translate(${r - 102}, -45)`;
            })
            .style("filter", "drop-shadow(2px 4px 6px rgba(0, 0, 0, 0.2))");

        // Añadir etiquetas de categorías en la ruleta
        arcs.append("text")
            .attr("transform", function (d) {
                const angle = (d.startAngle + d.endAngle) / 2 * 180 / Math.PI - 90;
                return `rotate(${angle})translate(${r - 65}, 40)`;
            })
            .attr("text-anchor", "middle")
            .text(function (d, i) { return data[i].label; });

        let isSpinning = false;

        function spin() {
            if (isSpinning) return;

            isSpinning = true;
            document.getElementById("spinButton").disabled = true;

            if (oldpick.length === data.length) oldpick = [];

            const ps = 360 / data.length;
            const rng = Math.floor((Math.random() * 1440) + 360);
            rotation = (Math.round(rng / ps) * ps);
            picked = Math.round(data.length - (rotation % 360) / ps);
            picked = picked >= data.length ? (picked % data.length) : picked;

            if (oldpick.indexOf(picked) !== -1) {
                spin();
                return;
            } else {
                oldpick.push(picked);
            }

            rotation += 90 - Math.round(ps / 2);
            vis.transition()
                .duration(3000)
                .ease("cubic-out")
                .attrTween("transform", rotTween)
                .each("end", function () {
                    const selectedCategory = data[picked].label;
                    fetchQuestionFromAPI(selectedCategory, "medium");
                    oldrotation = rotation;
                });
        }

        function fetchQuestionFromAPI(category, difficulty) {
            fetch(`/api/questions/generate?category=${encodeURIComponent(category)}&difficulty=${difficulty}`)
                .then(response => {
                    console.log("Estado de respuesta:", response.status); // Registro del estado de la respuesta
                    if (!response.ok) {
                        console.error(`Error al obtener la pregunta: ${response.status} - ${response.statusText}`);
                        throw new Error("Error al obtener la pregunta");
                    }
                    return response.json();
                })
                .then(questionData => {
                    console.log("Datos de la respuesta de la API:", questionData); // Log para ver el contenido de la respuesta
                    if (!questionData.question || !questionData.options) {
                        throw new Error("La respuesta de la API no contiene los datos esperados");
                    }
                    showQuestionModal(questionData.question, questionData.options);
                    isSpinning = false;
                    document.getElementById("spinButton").disabled = false;
                })
                .catch(error => {
                    console.error("Error en la solicitud o datos de la API:", error);
                    alert("Hubo un error al cargar la pregunta. Intenta de nuevo.");
                    isSpinning = false;
                    document.getElementById("spinButton").disabled = false;
                });
        }


        function rotTween(to) {
            var i = d3.interpolate(oldrotation % 360, rotation);
            return function (t) {
                return "rotate(" + i(t) + ")";
            };
        }

        const questionModal = document.getElementById("questionModal");

        function showQuestionModal(questionText, options) {
            document.getElementById("modal-question-text").textContent = questionText || "Pregunta no disponible";
            const modalOptions = document.querySelectorAll(".answer-button");

            modalOptions.forEach((button, index) => {
                if (options[index]) {
                    button.textContent = options[index];
                    button.style.display = "inline-block";
                    button.onclick = () => selectAnswer(options[index]);
                } else {
                    button.style.display = "none"; // Oculta botones si hay menos de 4 opciones
                }
            });

            questionModal.style.display = "flex";
        }

        function closeModal() {
            questionModal.style.display = "none";
        }

        function selectAnswer(selectedAnswer) {
            console.log("Respuesta seleccionada:", selectedAnswer);
            closeModal();
            isSpinning = false;
            document.getElementById("spinButton").disabled = false;
        }

    </script>

</body>

</html>